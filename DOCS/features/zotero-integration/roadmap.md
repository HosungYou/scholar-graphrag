# Zotero Hybrid Import Implementation Roadmap

> **Generated by**: Multi-Agent System (6 Parallel Agents)
> **Date**: 2025-01-15
> **Project**: ScholaRAG_Graph_Review

---

## Executive Summary

SUB_AGENTS_PLAN.md를 기반으로 6개 전문 에이전트가 병렬로 Zotero Hybrid Import 전략을 분석 및 설계했습니다.

### Agent Execution Summary

| Agent | Role | Status | Deliverables |
|-------|------|--------|--------------|
| **Explorer** (Haiku) | 프로젝트 구조 탐색 | ✅ 완료 | 전체 아키텍처 분석 |
| **Backend** (Sonnet) | API 구현 분석 | ✅ 완료 | API 설계 문서 |
| **Frontend** (Sonnet) | UI 컴포넌트 설계 | ✅ 완료 | `ZOTERO_IMPORTER_COMPONENT_DESIGN.md` |
| **Database** (Sonnet) | 스키마 설계 | ✅ 완료 | `005_zotero_hybrid_import.sql` |
| **Graph** (Sonnet) | KG 통합 설계 | ✅ 완료 | `CanonicalEntityRegistry` 설계 |
| **Test** (Sonnet) | 테스트 스위트 설계 | ✅ 완료 | 70+ 테스트 설계 |

---

## Current Implementation Status

### ✅ Completed (100%)
- Zotero Web API Client (`backend/integrations/zotero.py` - 876 lines)
- Basic API Endpoints (8 endpoints in `integrations.py`)
- PDF Importer (`backend/importers/pdf_importer.py`)
- ScholarAG Importer (`backend/importers/scholarag_importer.py`)
- Entity Extraction Pipeline
- Knowledge Graph Processing

### ❌ Missing (IMPROVEMENT_PLAN.md 8.9)
- HybridZoteroImporter class
- Zotero Local API Client (port 23119)
- Frontend ZoteroImporter UI
- Database schema extensions
- Test suite for hybrid import

---

## Implementation Roadmap

### Phase 1: Database Schema (Days 1-2)
**Priority: P0 (Critical)**

```
database/
└── migrations/
    └── 005_zotero_hybrid_import.sql   # 1,023 lines (DESIGNED)
```

**New Tables:**
- `zotero_collections` - Collection hierarchy
- `zotero_sync_state` - Incremental sync tracking
- `zotero_sync_history` - Audit log
- `entity_merge_history` - Source tracking
- `zotero_sync_conflicts` - Conflict resolution

**Extended Tables:**
- `entities` - Add `node_source`, `zotero_item_key`, `source_metadata`
- `paper_metadata` - Add sync fields

**Action Items:**
1. [ ] Review `005_zotero_hybrid_import.sql`
2. [ ] Run migration in Supabase
3. [ ] Verify indexes created
4. [ ] Test utility functions

---

### Phase 2: Backend Core (Days 3-7)
**Priority: P0 (Critical)**

```
backend/
├── integrations/
│   └── zotero_local.py                # NEW - Local API client
├── importers/
│   └── hybrid_zotero_importer.py      # NEW - Main importer
├── graph/
│   ├── node_source.py                 # NEW - Source enum
│   ├── canonical_entity_registry.py   # NEW - Deduplication (850 lines)
│   ├── zotero_metadata_extractor.py   # NEW - Metadata → Entities
│   └── entity_merger.py               # NEW - Merge logic
└── routers/
    └── import_.py                     # MODIFY - Add 3 endpoints
```

**Core Classes:**

```python
# backend/integrations/zotero_local.py
class ZoteroLocalClient:
    BASE_URL = "http://localhost:23119/api"

    async def check_connection() -> bool
    async def get_collections() -> List[ZoteroCollection]
    async def get_items(collection_key: str) -> List[ZoteroItem]
    async def get_pdf_file(item_key: str) -> bytes

# backend/importers/hybrid_zotero_importer.py
class HybridZoteroImporter:
    async def _phase1_zotero_extraction(collection_key) -> List[ExtractedNode]
    async def _phase2_pdf_extraction(items, config) -> List[ExtractedNode]
    async def _phase3_merge_deduplicate(zotero, pdf) -> List[ExtractedNode]
```

**Import Modes:**

| Mode | Cost/Paper | Coverage | Use Case |
|------|------------|----------|----------|
| `zotero_only` | $0 | 49% | Quick metadata |
| `selective` | ~$0.01 | 85% | **Recommended** |
| `full` | ~$0.02 | 88%+ | Complete analysis |

**New API Endpoints:**

```
GET  /api/import/zotero/status       # Check Zotero connection
GET  /api/import/zotero/collections  # List collections
POST /api/import/zotero/import       # Start hybrid import
```

**Action Items:**
1. [ ] Create `zotero_local.py` client
2. [ ] Implement `HybridZoteroImporter` (3 phases)
3. [ ] Create `CanonicalEntityRegistry` for deduplication
4. [ ] Add API endpoints to `import_.py`
5. [ ] Update `config.py` with settings

---

### Phase 3: Frontend UI (Days 8-10)
**Priority: P1 (High)**

```
frontend/
├── components/
│   └── import/
│       ├── ZoteroImporter.tsx          # NEW - Main container
│       ├── ZoteroConnectionStatus.tsx  # NEW - Status indicator
│       ├── CollectionSelector.tsx      # NEW - Collection dropdown
│       ├── ImportModeSelector.tsx      # NEW - Mode selection
│       ├── ImportProgressTracker.tsx   # NEW - Progress UI
│       └── ZoteroHelpPanel.tsx         # NEW - Help content
├── hooks/
│   ├── useZoteroConnection.ts          # NEW
│   ├── useZoteroCollections.ts         # NEW
│   └── useZoteroImport.ts              # NEW
└── types/
    └── zotero.ts                       # NEW - Type definitions
```

**Component Architecture:**

```
ZoteroImporter.tsx (Main Container)
├── ZoteroConnectionStatus.tsx
│   └── Badge (Connected/Disconnected)
├── CollectionSelector.tsx
│   └── Dropdown with item counts
├── ImportModeSelector.tsx
│   ├── Radio: Zotero Only (Free)
│   ├── Radio: Selective ($0.01/paper) [Recommended]
│   └── Radio: Full Analysis ($0.02/paper)
├── ImportProgressTracker.tsx
│   └── Progress bar + stage labels
└── ZoteroHelpPanel.tsx
    └── Collapsible help content
```

**State Management:**
- Zustand: Client state (connection, UI)
- React Query: Server state (collections, jobs)

**Action Items:**
1. [ ] Create component files
2. [ ] Implement React Query hooks
3. [ ] Add to Import page
4. [ ] Style with Tailwind CSS
5. [ ] Add accessibility features

---

### Phase 4: Testing (Days 11-14)
**Priority: P1 (High)**

```
backend/tests/
├── zotero/
│   ├── conftest.py                     # Fixtures
│   ├── test_zotero_local_client.py     # 12 tests
│   ├── test_hybrid_importer.py         # 25 tests
│   └── test_merge_logic.py             # 15 tests
├── integration/
│   ├── test_zotero_desktop.py          # 3 tests
│   └── test_database_integration.py    # 6 tests
└── e2e/
    └── test_zotero_api_endpoints.py    # 4 tests
```

**Test Pyramid:**
```
         E2E (5 tests)
     Integration (15 tests)
    Unit Tests (50+ tests)
```

**Coverage Targets:**

| Module | Target |
|--------|--------|
| `zotero_local.py` | 85% |
| `hybrid_zotero_importer.py` | 90% |
| Merge logic | 95% |
| API routes | 80% |
| **Overall** | **80%** |

**Action Items:**
1. [ ] Create fixtures and mock data
2. [ ] Write unit tests
3. [ ] Write integration tests
4. [ ] Configure CI/CD pipeline
5. [ ] Achieve 80% coverage

---

## Detailed Component Specifications

### CanonicalEntityRegistry (Graph Agent Design)

**Purpose**: Deduplicate entities from multiple sources

**Algorithm:**
```
1. Normalize name (lowercase, strip punctuation)
2. Check synonym dictionary ("AI" ↔ "artificial intelligence")
3. Calculate Jaccard similarity for fuzzy match
4. Calculate embedding similarity for semantic match
5. Return canonical entity or create new
```

**Thresholds:**
- Exact match: 1.0
- Name similarity: ≥ 0.8 (Jaccard)
- Embedding similarity: ≥ 0.85 (Cosine)

### NodeSource Enum

```python
class NodeSource(Enum):
    ZOTERO = "zotero"           # 100% confidence
    PDF_LLM = "pdf_llm"         # 70-90% confidence
    MANUAL = "manual"           # User-created
    MERGED = "merged"           # Combined result
    AUTO_INFERRED = "auto"      # System inferred
```

### Coverage Targets (IMPROVEMENT_PLAN.md 8.9.1)

| Node Type | Zotero Only | PDF Only | Hybrid |
|-----------|-------------|----------|--------|
| Paper | 100% | 70% | **100%** |
| Author | 100% | 60% | **100%** |
| Tag/Concept | 95% | 75% | **95%+** |
| Method | 0% | 85% | **85%** |
| Finding | 0% | 80% | **80%** |
| Effect Size | 0% | 70% | **70%** |
| **Overall** | 49% | 74% | **88%+** |

---

## Generated Documentation

에이전트들이 생성한 문서 목록:

### Database Agent
- `database/migrations/005_zotero_hybrid_import.sql` (1,023 lines)
- `database/ZOTERO_SCHEMA_DESIGN.md` (678 lines)
- `database/ZOTERO_SCHEMA_DIAGRAM.md` (456 lines)
- `database/ZOTERO_INTEGRATION_SUMMARY.md` (410 lines)

### Frontend Agent
- `ZOTERO_IMPORTER_COMPONENT_DESIGN.md`

### Backend Agent
- `backend/importers/ZOTERO_IMPORTER_IMPLEMENTATION.md` (587 lines)

### Test Agent
- `backend/tests/ZOTERO_HYBRID_IMPORT_TEST_DESIGN.md` (58KB)
- `backend/tests/TEST_ARCHITECTURE_DIAGRAM.md` (27KB)
- `backend/tests/IMPLEMENTATION_GUIDE.md` (12KB)

---

## Timeline Summary

| Phase | Duration | Key Deliverables |
|-------|----------|------------------|
| **Phase 1**: Database | 2 days | Migration script, schema |
| **Phase 2**: Backend | 5 days | Importer, API endpoints |
| **Phase 3**: Frontend | 3 days | UI components, hooks |
| **Phase 4**: Testing | 4 days | 70+ tests, CI/CD |
| **Total** | **14 days** | Complete implementation |

---

## Risk Factors

1. **Zotero Desktop Dependency**: Local API requires desktop app running
2. **PDF Extraction Costs**: Monitor LLM token usage
3. **Sync Conflicts**: May need manual resolution UI
4. **Performance**: Large collections (1000+ papers) need batching

---

## Next Steps

### Immediate Actions
1. Review generated documentation in `ScholaRAG_Graph_Review/`
2. Run database migration `005_zotero_hybrid_import.sql`
3. Start implementing `ZoteroLocalClient`

### Follow-up Questions
- Which import mode should be default? (Recommended: `selective`)
- Should we support Zotero Web API fallback when Desktop unavailable?
- What conflict resolution strategy for duplicate entities?

---

*This roadmap was generated by 6 parallel agents analyzing SUB_AGENTS_PLAN.md and IMPROVEMENT_PLAN.md.*
