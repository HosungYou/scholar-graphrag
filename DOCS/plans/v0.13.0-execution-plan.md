# v0.13.0 Execution Plan — Paper Citation Network

> **Base Plan**: `DOCS/plans/v0.13.0-plan.md`
> **Created**: 2026-02-07
> **Status**: Ready for execution

---

## Critical Fixes (Plan vs. Reality)

The original plan has **3 schema/import issues** that must be corrected during implementation:

### Fix 1: `publication_year` does NOT exist

**Plan assumes**: `pm.publication_year` in SQL query (line 352)
**Reality**: Column is `year INTEGER` (migration 004, line 192)

```sql
-- WRONG (plan):
SELECT pm.id, pm.title, pm.doi, pm.publication_year, ...
-- CORRECT:
SELECT pm.id, pm.title, pm.doi, pm.year, ...
```

### Fix 2: `properties->>'semantic_scholar_id'` does NOT exist

**Plan assumes**: `pm.properties->>'semantic_scholar_id'` (line 353)
**Reality**: `paper_metadata` has NO `properties JSONB` column. It has `paper_id VARCHAR(255)` (original ScholaRAG ID, not S2 ID).

**Solution**: Remove S2 ID from the query. Rely solely on DOI for S2 lookup. Most Zotero-imported papers have DOIs. Papers without DOIs will be skipped (already handled in the plan's "X of Y matched" UX).

```sql
-- WRONG (plan):
SELECT pm.id, pm.title, pm.doi, pm.publication_year,
       pm.properties->>'semantic_scholar_id' as s2_id
FROM paper_metadata pm
WHERE pm.project_id = $1
AND (pm.doi IS NOT NULL OR pm.properties->>'semantic_scholar_id' IS NOT NULL)

-- CORRECT:
SELECT pm.id, pm.title, pm.doi, pm.year
FROM paper_metadata pm
WHERE pm.project_id = $1
AND pm.doi IS NOT NULL
```

### Fix 3: `BackgroundTasks` import missing

**Plan note** (line 451): "Add `from fastapi import BackgroundTasks`"
**Reality**: Not in current imports. Must add.

### Fix 4: `project_id` type in SQL

**Existing pattern**: All queries use `str(project_id)` (e.g., graph.py:1195)
**Plan**: Passes `project_id` (UUID) directly to SQL
**Fix**: Use `str(project_id)` consistently

---

## Pre-Step: None needed

Working tree is clean. No stash required.

---

## Phase 1: Citation Builder Module (New File)

### File: `backend/graph/citation_builder.py` — NEW

Create the file as specified in the plan (lines 72-283) with these corrections:

1. In `build_citation_network()`, the `papers` dict will NOT have `semantic_scholar_id` key
2. Remove `s2_id = paper.get("semantic_scholar_id")` logic
3. Only use DOI path: `s2_paper = await client.get_paper(f"DOI:{doi}")`
4. Skip papers without DOI entirely

**Corrected paper resolution loop**:
```python
for paper in papers:
    doi = paper.get("doi")
    local_id = paper.get("local_id")
    title = paper.get("title", "")
    year = paper.get("year")

    if not doi:
        status.progress += 1
        continue

    s2_paper = await client.get_paper(f"DOI:{doi}")

    if s2_paper:
        matched += 1
        node = CitationNode(
            paper_id=s2_paper.paper_id,
            local_id=local_id,
            title=s2_paper.title or title,
            year=s2_paper.year or year,
            citation_count=s2_paper.citation_count,
            doi=s2_paper.doi or doi,
            is_local=True,
        )
        nodes[s2_paper.paper_id] = node

    status.progress += 1
```

### Commit 1
```
feat(citation): on-demand citation builder with in-memory cache
File: backend/graph/citation_builder.py (NEW)
```

---

## Phase 2: Backend API Endpoints

### File: `backend/routers/graph.py`

**Import addition** (line 16, after existing FastAPI imports):
```python
from fastapi import APIRouter, HTTPException, Query, Depends, BackgroundTasks
```
(Add `BackgroundTasks` to existing import)

**Insertion point**: After line 2965 (temporal timeline endpoint ends), before line 2968 (`# Relationship Evidence API` section)

**Models + 3 endpoints** as specified in plan (lines 292-448) with these corrections:

1. SQL query fix (Fix 1 + Fix 2):
```python
paper_rows = await database.fetch(
    """
    SELECT pm.id, pm.title, pm.doi, pm.year
    FROM paper_metadata pm
    WHERE pm.project_id = $1
    AND pm.doi IS NOT NULL
    """,
    str(project_id),
)
```

2. Paper dict construction fix:
```python
papers = [
    {
        "local_id": str(row["id"]),
        "title": row["title"],
        "doi": row["doi"],
        "year": row["year"],
    }
    for row in paper_rows
]
```

3. Use `str(project_id)` consistently (Fix 4)

### Commit 2
```
feat(citation): citation network API endpoints (build/status/network)
File: backend/routers/graph.py
```

---

## Phase 3: Frontend Implementation

### File 1: `frontend/types/graph.ts` (line 331)

```typescript
// BEFORE:
export type ViewMode = '3d' | 'topic' | 'gaps' | 'temporal';
// AFTER:
export type ViewMode = '3d' | 'topic' | 'gaps' | 'temporal' | 'citations';
```

### File 2: `frontend/lib/api.ts`

Insert after `getTemporalTimeline()` method. 3 new methods:
- `buildCitationNetwork(projectId)`
- `getCitationBuildStatus(projectId)`
- `getCitationNetwork(projectId)`

As specified in plan lines 821-858.

### File 3: `frontend/components/graph/CitationView.tsx` — NEW

Create the full component as specified in plan lines 457-771.
No corrections needed — the component only uses API responses, not DB directly.

### File 4: `frontend/components/graph/KnowledgeGraph3D.tsx`

4 changes:

**4a. Import** (after line 16):
```typescript
import { CitationView } from './CitationView';
```

**4b. View rendering** (after line 371, after temporal view block):
```tsx
{viewMode === 'citations' && (
  <CitationView projectId={projectId} />
)}
```

**4c. Tab button** (after line 569, after Temporal tab button, before `</div>`):
```tsx
{/* Citation Network - v0.13.0 */}
<button
  onClick={() => setViewMode('citations')}
  className={`flex items-center gap-1.5 px-3 py-1.5 rounded text-sm font-medium transition-all ${
    viewMode === 'citations'
      ? 'bg-[#457B9D] text-white shadow-sm'
      : 'text-ink/70 dark:text-paper/70 hover:text-ink dark:hover:text-paper hover:bg-ink/10 dark:hover:bg-paper/10'
  }`}
  title="논문 인용 네트워크 (Citations)"
>
  <GitBranch className="w-4 h-4" />
  <span className="font-mono text-xs uppercase tracking-wider">Citations</span>
</button>
```

**4d. Import `GitBranch`** from lucide-react (add to existing import block)

**4e. Status bar badge** (after line ~704 temporal badge area): Add citations badge similar to temporal badge.

### Commit 3
```
feat(citation): Litmaps-style scatter plot citation view
Files: CitationView.tsx (NEW), KnowledgeGraph3D.tsx, api.ts, types/graph.ts
```

---

## Phase 4: Documentation

- `RELEASE_NOTES_v0.13.0.md` — NEW
- `DOCS/architecture/SDD.md` — v0.13.0 Change Log entry
- `DOCS/testing/TDD.md` — v0.13.0 regression design section

### Commit 4
```
docs(v0.13.0): release notes, SDD and TDD updates
```

---

## Execution Order

```
1. Create backend/graph/citation_builder.py (NEW) → Commit 1
2. Add 3 endpoints to graph.py + BackgroundTasks import → Commit 2
3. Update types → api.ts → Create CitationView.tsx → Update KnowledgeGraph3D → Commit 3
4. Documentation → Commit 4
5. Push
```

---

## Key References (Line Numbers as of 81a4f15)

| Resource | Location |
|----------|----------|
| `SemanticScholarClient.__init__` | `semantic_scholar.py:147` |
| `get_paper()` (DOI lookup) | `semantic_scholar.py:349` |
| `get_references()` (ref list) | `semantic_scholar.py:463` |
| `SemanticScholarPaper` dataclass | `semantic_scholar.py:24-45` |
| `paper_metadata` CREATE TABLE | `migration 004:178-210` |
| `paper_metadata.doi` column | `migration 004:184` |
| `paper_metadata.year` column | `migration 004:192` |
| Temporal section end (insert after) | `graph.py:2965` |
| Relationship Evidence (insert before) | `graph.py:2968` |
| `BackgroundTasks` — needs import | `graph.py:16` (add to existing) |
| `ViewMode` type definition | `types/graph.ts:331` |
| KnowledgeGraph3D imports | `KnowledgeGraph3D.tsx:1-20` |
| Temporal tab button (insert after) | `KnowledgeGraph3D.tsx:569` |
| Temporal view rendering (insert after) | `KnowledgeGraph3D.tsx:371` |
| `getTemporalTimeline()` (insert after) | `api.ts:~line after temporal methods` |

---

## Risk Mitigations

| Risk | Plan Mitigation | Additional Note |
|------|-----------------|-----------------|
| No `properties` JSONB → no S2 ID | DOI-only lookup | Most Zotero papers have DOIs |
| `year` vs `publication_year` | Use correct column `year` | Verified in migration 004 |
| Rate limiting (100 req/5min) | Built-in `_rate_limit()` in client | 34 papers × 2 requests (resolve + refs) = ~68 requests |
| Render memory (512MB) | 34 papers × 50 refs = ~1700 nodes | Well within limits |
| Build job concurrent access | `asyncio.Lock` per project | Already in plan |

---

## Verification

```bash
# Phase 1: Syntax check
python3 -m py_compile backend/graph/citation_builder.py

# Phase 2: Endpoint check
curl -X POST http://localhost:8000/api/graph/citation/{pid}/build \
  -H "Authorization: Bearer $TOKEN"
# → {"message": "Building citation network for N papers", "state": "building"}

curl http://localhost:8000/api/graph/citation/{pid}/status \
  -H "Authorization: Bearer $TOKEN"
# → {"state": "completed", "progress": N, "total": N}

curl http://localhost:8000/api/graph/citation/{pid}/network \
  -H "Authorization: Bearer $TOKEN"
# → {"nodes": [...], "edges": [...], "papers_matched": X, "papers_total": Y}

# Phase 3: Frontend
# → Citations tab visible in view mode bar
# → Click "Build Citation Network" → progress bar → scatter plot
# → Local papers (teal, large) + referenced papers (blue, small)
# → Hover tooltip with title/year/citations
```
