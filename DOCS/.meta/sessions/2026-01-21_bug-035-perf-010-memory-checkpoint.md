# Session Log: BUG-035 & PERF-010 Fixes

> **Session ID**: 2026-01-21_bug-035-perf-010-memory-checkpoint
> **Date**: 2026-01-21T09:30:00Z
> **Agent**: Opus 4.5
> **Type**: bugfix-performance
> **Duration**: 20 minutes

---

## Context

### User Report
1. **메모리 초과 재발**: PERF-009 적용 후에도 Render 서버 메모리 초과로 재시작
2. **Resume 버그**: "Cannot resume: Checkpoint is missing project_id" 에러 발생
3. **HTTP 400 Bad Request**: POST `/api/import/resume/{job_id}` 실패

### Root Cause Analysis

#### BUG-035: Checkpoint Missing project_id
- **문제**: checkpoint가 import 진행 중에 저장되지만, project_id는 import 완료 후에야 설정됨
- **코드 흐름**:
  1. `current_project_id = existing_project_id` (새 import 시 None)
  2. progress callback마다 checkpoint 저장 (project_id = None)
  3. import 완료 후에야 `current_project_id` 업데이트
- **결과**: checkpoint에 project_id가 없어서 Resume 실패

#### PERF-009 부족: Memory Still Exceeded
- batch_size = 20으로도 512MB 메모리 초과
- Cohere/OpenAI embedding 호출 시 메모리 급증

---

## Solutions Applied

### BUG-035 Fix: Update Checkpoint with project_id

**File**: `backend/routers/import_.py`

import 완료 후 checkpoint를 명시적으로 업데이트:

```python
# BUG-035 FIX: Update checkpoint with project_id immediately
# Checkpoint may have been saved during import without project_id
# because project is created DURING processing, not before
try:
    existing_job = await job_store.get_job(job_id)
    if existing_job and existing_job.metadata.get("checkpoint"):
        checkpoint = existing_job.metadata["checkpoint"]
        checkpoint["project_id"] = current_project_id
        await job_store.update_job(
            job_id=job_id,
            metadata={"checkpoint": checkpoint},
        )
except Exception as e:
    logger.warning(f"Failed to update checkpoint with project_id: {e}")
```

### PERF-010: Aggressive Memory Optimization

| File | Before | After |
|------|--------|-------|
| `cohere_embeddings.py` | batch_size = 20 | batch_size = 5 |
| `openai_embeddings.py` | batch_size = 20 | batch_size = 5 |
| `embedding_pipeline.py` | batch_size = 20 | batch_size = 5 |
| `graph_store.py` | batch_size = 20 | batch_size = 5 |
| `config.py` | cache_max_size = 100 | cache_max_size = 50 |

**예상 메모리 절약**: 추가 ~50-100MB

---

## Commits

| Commit | Description |
|--------|-------------|
| `2394469` | fix(BUG-035): Update checkpoint with project_id after import completes |

---

## Files Modified

| File | Change |
|------|--------|
| `backend/routers/import_.py` | BUG-035 fix: checkpoint project_id 업데이트 |
| `backend/llm/cohere_embeddings.py` | batch_size: 20 → 5 |
| `backend/llm/openai_embeddings.py` | batch_size: 20 → 5 |
| `backend/graph/embedding/embedding_pipeline.py` | batch_size: 20 → 5 |
| `backend/graph/graph_store.py` | batch_size: 20 → 5 |
| `backend/config.py` | cache_max_size: 100 → 50 |

---

## Deployment Required

| Service | Platform | Action |
|---------|----------|--------|
| Backend | Render | Manual Deploy 필요 (Auto-Deploy OFF) |
| Frontend | Vercel | 변경 없음 |

---

## Next Steps

1. **Render Manual Deploy** 실행
2. **Import 재시도** - Resume 버튼 또는 새 import
3. **메모리 모니터링** - 60-70% 이하 유지 확인
4. **문제 지속 시**: Render 인스턴스 업그레이드 검토 ($15/월 for 1GB RAM)

---

## Session Statistics

| Metric | Value |
|--------|-------|
| Files Read | 6 |
| Files Modified | 6 |
| Commits | 1 |
| Bugs Fixed | 1 (BUG-035) |
| Performance Fixes | 1 (PERF-010) |

---

*Generated by Claude Code (Opus 4.5)*
