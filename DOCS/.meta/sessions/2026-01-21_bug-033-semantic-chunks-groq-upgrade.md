# Session Log: BUG-033 semantic_chunks Migration & Groq Upgrade

> **Session ID**: 2026-01-21_bug-033-semantic-chunks-groq-upgrade
> **Date**: 2026-01-21T08:30:00Z
> **Agent**: Opus 4.5
> **Type**: bugfix-infrastructure
> **Duration**: 30 minutes

---

## Context

### User Request
배포 후 import 시도 시 발생한 에러 분석 및 해결 요청:
1. `relation "semantic_chunks" does not exist`
2. `Groq rate limit reached (429 Too Many Requests)`
3. `LLM extraction failed after 3 retries`

### Related Issues
- BUG-032: Groq API Rate Limiting (이전 세션에서 retry 로직 추가됨)
- 011_semantic_chunks.sql: 마이그레이션 파일 존재하나 미적용

---

## Problem Analysis

### Problem 1: semantic_chunks Table Missing
- **Symptom**: `WARNING:graph.persistence.chunk_dao:Failed to store parent chunk: relation "semantic_chunks" does not exist`
- **Root Cause**: 마이그레이션 파일 `database/migrations/011_semantic_chunks.sql`이 Supabase에 적용되지 않음
- **Impact**: PDF import 시 semantic chunking 기능 완전 실패

### Problem 2: Groq Rate Limit (429)
- **Symptom**: `Rate limit reached for model llama-3.1-8b-instant... Limit 500000, Used 499698`
- **Root Cause**: Groq 무료 티어의 하루 토큰 한도(500,000) 초과
- **Impact**: Entity extraction 완전 실패, import 중단

### Problem 3: No LLM Fallback
- **Symptom**: `ERROR:llm.groq_provider:Groq generate failed after 3 retries`
- **Root Cause**: Groq 실패 시 다른 LLM provider로 전환하는 fallback 메커니즘 없음
- **Impact**: 단일 provider 장애 시 전체 시스템 장애

---

## Solution Applied

### Solution 1: Supabase Migration Execution
사용자가 Supabase SQL Editor에서 `011_semantic_chunks.sql` 마이그레이션 직접 실행

**Executed SQL**:
```sql
CREATE TABLE IF NOT EXISTS semantic_chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    paper_id UUID REFERENCES paper_metadata(id) ON DELETE CASCADE,
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    text TEXT NOT NULL,
    summary TEXT,
    section_type VARCHAR(50) NOT NULL DEFAULT 'unknown',
    section_title VARCHAR(500),
    parent_chunk_id UUID REFERENCES semantic_chunks(id) ON DELETE CASCADE,
    chunk_level INTEGER NOT NULL DEFAULT 0,
    embedding vector(1536),
    token_count INTEGER,
    sequence_order INTEGER NOT NULL DEFAULT 0,
    start_line INTEGER,
    end_line INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ...
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_semantic_chunks_paper_id ON semantic_chunks(paper_id);
CREATE INDEX IF NOT EXISTS idx_semantic_chunks_project_id ON semantic_chunks(project_id);
CREATE INDEX IF NOT EXISTS idx_semantic_chunks_embedding_hnsw ON semantic_chunks
    USING hnsw (embedding vector_cosine_ops) WITH (m = 16, ef_construction = 64);

-- RLS
ALTER TABLE semantic_chunks ENABLE ROW LEVEL SECURITY;
```

### Solution 2: Groq Dev Tier Upgrade
사용자가 Groq 콘솔에서 Dev Tier로 업그레이드

**Before**: Free Tier (500K tokens/day)
**After**: Dev Tier (7M tokens/day)

**Console URL**: https://console.groq.com/settings/billing

---

## Decision Log

| Decision | Option Chosen | Rationale |
|----------|---------------|-----------|
| Rate limit 해결 방법 | Groq Dev Tier 업그레이드 | 비용 효율적($2/월), 즉시 적용, 장기적 안정성 |
| Fallback LLM 구현 | 보류 | 업그레이드로 당장 문제 해결, 추후 필요시 구현 |

---

## Files Analyzed

| File | Purpose |
|------|---------|
| `database/migrations/011_semantic_chunks.sql` | 누락된 테이블 마이그레이션 |
| `backend/llm/groq_provider.py` | Rate limiting 구현 확인 |
| `backend/graph/entity_extractor.py` | LLM fallback 로직 확인 |
| `backend/graph/persistence/chunk_dao.py` | 청크 저장 로직 확인 |

---

## Outcome

### Status: Completed

| Task | Status |
|------|--------|
| 문제 분석 | ✅ |
| semantic_chunks 마이그레이션 | ✅ 사용자 실행 완료 |
| Groq Dev Tier 업그레이드 | ✅ 사용자 실행 완료 |

### Next Steps
1. Import 재시도하여 정상 작동 확인
2. (선택) LLM fallback 메커니즘 구현 검토 - Groq → OpenAI/Claude 자동 전환

---

## Session Statistics

| Metric | Value |
|--------|-------|
| Files Read | 4 |
| Files Created | 1 (이 세션 로그) |
| Files Modified | 2 (action-items.md, agent-registry.json) |
| Bugs Identified | 3 |
| Bugs Resolved | 3 |
| User Actions Required | 2 (migration, upgrade) |

---

*Generated by Claude Code (Opus 4.5)*
