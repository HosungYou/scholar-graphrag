# Session: Phase 0 — Entity Deduplication + Frequency Sizing

## Context
- Phase: v0.20.1 (Phase 0)
- Tasks: 0-1 (DB Migration), 0-2 (Application Upsert), 0-3 (Importer Fix), 0-3 (Frequency Sizing)
- Files touched:
  - `database/migrations/004_entity_deduplication.sql` (NEW)
  - `backend/graph/graph_store.py` (MODIFIED)
  - `backend/importers/scholarag_importer.py` (MODIFIED)
  - `backend/routers/graph.py` (MODIFIED)
  - `frontend/components/graph/CustomNode.tsx` (MODIFIED)
  - `frontend/components/graph/NodeDetails.tsx` (MODIFIED)

## Changes Summary

### 1. DB Migration: Entity Deduplication (004_entity_deduplication.sql)
- CTE-based migration wrapped in BEGIN/COMMIT transaction
- Identifies duplicates by `(project_id, entity_type, LOWER(TRIM(name)))`
- Canonical entity = oldest (earliest `created_at`)
- Merges JSONB properties from duplicates into canonical
- Rewrites `source_id` and `target_id` in relationships to canonical
- Removes duplicate relationships after entity merge
- Deletes non-canonical entities
- Creates UNIQUE INDEX `idx_entities_unique_name` to prevent future duplicates
- Returns operation summary counts

### 2. Application-Level Upsert (graph_store.py)
- `_db_add_entity()`: Changed from `ON CONFLICT (id)` to `ON CONFLICT (project_id, entity_type, LOWER(TRIM(name)))`
- Properties merged with `||` operator (existing preserved, new added)
- Embedding preserved with `COALESCE(EXCLUDED.embedding, entities.embedding)`
- Added `RETURNING id` to get actual entity ID
- Changed from `self.db.execute()` to `self.db.fetchval()`
- `add_entity()`: Now returns the actual DB ID (existing or new)

### 3. Importer Dedup Fix (scholarag_importer.py)
- `_store_entities()`: Same name-based upsert pattern as graph_store
- Changed from `ON CONFLICT (id) DO NOTHING` to name-based upsert with `RETURNING id`
- Fixed mapping sequencing: `id_mapping`, `_paper_id_map`, `author_name_to_uuid`, `concept_name_to_uuid` all updated AFTER upsert returns actual ID
- In-memory caches preserved as session-level optimization

### 4. API paper_count Enrichment (routers/graph.py)
- `get_visualization_data()`: Added paper_count enrichment query after node fetch
- Single efficient GROUP BY query counts relationships (DISCUSSES_CONCEPT, USES_METHOD, SUPPORTS, AUTHORED_BY)
- Merged into node properties for non-Paper entities

### 5. Frontend Frequency Sizing (CustomNode.tsx, NodeDetails.tsx)
- `CustomNode.tsx`: Added `paperCount` to interface, frequency-based scaling with `Math.log2` capped at 0.3, paper_count badge display
- `NodeDetails.tsx`: Universal paper_count badge in header using IIFE for type safety
- TypeScript compilation passes with zero errors

## Issues Encountered

### Issue 1: Plan-to-Codebase Mismatch
- **Symptom**: Plan referenced files that don't exist (entity_dao.py, Graph3D.tsx, lod.ts, entity_resolution.py)
- **Root Cause**: Plan was written based on assumed architecture, not actual codebase
- **Resolution**: Mapped plan references to actual files (graph_store.py, KnowledgeGraph.tsx/CustomNode.tsx, etc.)

### Issue 2: ID Mapping Sequencing Bug
- **Symptom**: `id_mapping[local_id]` was set before upsert, using pre-generated UUID instead of actual DB ID
- **Root Cause**: Original Task 3 executor placed mapping before the upsert call
- **Resolution**: Moved all mapping assignments (id_mapping, _paper_id_map, author/concept name maps) to after the `RETURNING id` upsert
- **File:Line**: `backend/importers/scholarag_importer.py:798-825`

### Issue 3: TypeScript Type Safety in NodeDetails
- **Symptom**: TS2322 error — `Type 'unknown' is not assignable to type 'ReactNode'`
- **Root Cause**: Direct interpolation of `(node.properties as Record<string, unknown>).paper_count` in JSX
- **Resolution**: Used IIFE pattern with explicit `String()` conversion
- **File:Line**: `frontend/components/graph/NodeDetails.tsx:410-421`

## Decisions Made
- Used `LOWER(TRIM(name))` for normalization (case-insensitive + whitespace-trimmed)
- Properties merge uses `||` (existing || new) — preserves existing data, adds new fields
- Paper_count enrichment done in API layer (routers/graph.py) not in graph_store — keeps store generic
- Frequency boost capped at 0.3 scale increase to prevent oversized nodes
- Log2-based scaling for frequency (diminishing returns for very high counts)

## Verification Checklist
- [x] Python syntax validation passes (py_compile)
- [x] TypeScript compilation passes (tsc --noEmit)
- [x] Migration is idempotent (can run multiple times safely)
- [x] UNIQUE index prevents future duplicates
- [x] Upsert returns correct ID (existing or new)
- [x] ID mappings use actual DB IDs
- [ ] Run migration on production DB
- [ ] Test re-import (same project twice → no new entities)
- [ ] Visual verification: frequency-based sizing in UI

## Remaining Work
- [ ] Run migration 004 on production database
- [ ] Test with actual ScholaRAG project re-import
- [ ] Verify frontend paper_count badges render correctly
- [ ] Proceed to Phase 1 (v0.21): Lexical Graph expansion
