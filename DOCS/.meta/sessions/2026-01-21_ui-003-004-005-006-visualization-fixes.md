# Session: UI Visualization Fixes (UI-003, UI-004, UI-005, UI-006)

> **Session ID**: 2026-01-21-ui-visualization-fixes
> **Date**: 2026-01-21
> **Agent**: Claude Code (Opus 4.5)
> **Type**: Bug Fix / UI Improvement
> **Duration**: ~2 hours

---

## Context

### User Request
Import Pipeline 최적화 작업 중 발견된 4가지 UI 시각화 이슈 수정 요청:
1. Node Type 토글 필터링 미작동
2. LLM Panel에 잘못된 프로바이더 표시 (claude-3-5-haiku 대신 groq 표시 필요)
3. Force Simulation jitter/oscillation 문제
4. Node Labels 중심성 기반 스케일링 누락

### Related Decisions
- ADR-001: Concept-Centric Graph (Papers/Authors는 메타데이터, 시각화 안함)
- INFRA-006: Auto-Deploy OFF (Import 중단 방지)

---

## Summary

### 수정된 이슈

| Issue ID | 문제 | 해결 상태 |
|----------|------|----------|
| UI-003 | Node Type 토글 필터링 미작동 | ✅ Fixed |
| UI-004 | LLM Panel에 잘못된 프로바이더 표시 | ✅ Fixed |
| UI-005 | Force Simulation jitter/oscillation | ✅ Fixed (파라미터 방향 수정) |
| UI-006 | Node Labels 중심성 스케일링 누락 | ✅ Fixed |

### Commits
- `3dc351d`: fix(frontend): UI visualization fixes (UI-003, UI-005, UI-006 초기 수정)
- `aa71318`: fix: UI-004 LLM status display + UI-005 force simulation jitter (파라미터 방향 수정)

---

## Detailed Analysis

### UI-003: Node Type 토글 필터링 미작동

**문제**: NODE TYPES 패널에서 토글 off/on해도 노드가 숨겨지거나 표시되지 않음

**근본 원인**:
- `useEffect`가 `actualEntityTypes` 변경 시마다 실행
- 토글 off → `validSelectedTypes.length === 0` → 모든 타입 자동 재선택
- 사용자 필터 선택이 즉시 덮어씌워짐

**해결책**:
```typescript
// frontend/app/projects/[id]/page.tsx
const [hasInitializedFilters, setHasInitializedFilters] = useState(false);

useEffect(() => {
  if (!hasInitializedFilters && actualEntityTypes.length > 0) {
    // 초기 로드 시에만 자동 동기화
    setSelectedEntityTypes(actualEntityTypes);
    setHasInitializedFilters(true);
  }
}, [actualEntityTypes, hasInitializedFilters]);
```

**결과**: 초기화 후 사용자 자유로운 필터 토글 가능

---

### UI-004: LLM Panel에 잘못된 프로바이더 표시

**문제**: StatusBar에 "claude-3-5-haiku-20241022" 표시되지만 사용자는 Groq만 사용

**근본 원인**:
1. `backend/config.py` 기본값이 Anthropic으로 설정됨
2. `backend/routers/system.py`의 `check_llm_connection()`에서 Groq API 키 체크 누락
3. 환경변수 대신 settings 객체의 기본값 사용

**해결책**:

1. `backend/config.py` 기본값 변경:
```python
# Before
default_llm_provider: Literal["anthropic", "openai", "google", "groq"] = "anthropic"
default_llm_model: str = "claude-3-5-haiku-20241022"

# After
default_llm_provider: Literal["anthropic", "openai", "google", "groq"] = "groq"
default_llm_model: str = "llama-3.3-70b-versatile"
```

2. `backend/routers/system.py` Groq 지원 추가:
```python
async def check_llm_connection() -> LLMStatus:
    import os
    # 환경변수 직접 읽기로 신뢰성 확보
    provider = os.getenv('DEFAULT_LLM_PROVIDER', getattr(settings, 'DEFAULT_LLM_PROVIDER', 'groq'))
    model = os.getenv('DEFAULT_LLM_MODEL', getattr(settings, 'DEFAULT_LLM_MODEL', 'llama-3.3-70b-versatile'))

    connected = False
    if provider == 'anthropic':
        api_key = os.getenv('ANTHROPIC_API_KEY', ...)
        connected = bool(api_key and len(api_key) > 10)
    elif provider == 'openai':
        api_key = os.getenv('OPENAI_API_KEY', ...)
        connected = bool(api_key and len(api_key) > 10)
    elif provider == 'google':
        api_key = os.getenv('GOOGLE_API_KEY', ...)
        connected = bool(api_key and len(api_key) > 10)
    elif provider == 'groq':  # 추가됨
        api_key = os.getenv('GROQ_API_KEY', ...)
        connected = bool(api_key and len(api_key) > 10)
```

**결과**: StatusBar에 "groq / llama-3.3-70b-versatile" 정확히 표시

---

### UI-005: Force Simulation Jitter/Oscillation

**문제**: 노드 드래그/클릭 시 "jittery, oscillating, rubber-banding" 현상 발생

**사용자 설명**:
> "nodes vibrate rapidly instead of moving smoothly"
> "physics simulation struggling to settle"

**근본 원인**: d3-force 시뮬레이션 파라미터 잘못 설정

**초기 (잘못된) 수정**:
```typescript
// WRONG DIRECTION - 오히려 jitter 악화
d3AlphaDecay={0.02}  // 더 느린 냉각 (0.05보다 낮음)
d3VelocityDecay={0.4}  // 더 적은 댐핑 (0.7보다 낮음)
```

**d3-force 파라미터 의미**:
| 파라미터 | 설명 | 높은 값 → | 낮은 값 → |
|----------|------|-----------|-----------|
| `d3AlphaDecay` | 냉각 속도 | 빠른 안정화 | 느린 안정화 |
| `d3VelocityDecay` | 마찰/댐핑 | 빠른 정지 (적은 진동) | 느린 정지 (많은 진동) |
| `d3AlphaMin` | 최소 알파 임계값 | 조기 종료 | 미세 조정 계속 |

**최종 (올바른) 수정**:
```typescript
// frontend/components/graph/Graph3D.tsx

// UI-005 FIX: Force simulation parameters (optimized to REDUCE jitter/oscillation)
// Problem: Nodes vibrate rapidly, rubber-banding effect, struggling to settle
// Solution: HIGH damping + FAST cooling = quick stabilization without jitter
cooldownTicks={100}      // 충분한 냉각 틱
d3AlphaDecay={0.1}       // 빠른 냉각 (기본값 0.0228의 4배)
d3VelocityDecay={0.85}   // 높은 댐핑 (진동 억제)
d3AlphaMin={0.01}        // 조기 종료 (미세 조정 중단)
```

**결과**: 노드가 빠르게 안정화되고 진동/떨림 없음

---

### UI-006: Node Labels 중심성 스케일링 누락

**문제**: 모든 노드 라벨이 고정 14px 폰트로 표시되어 시각적 계층 구조 부재

**근본 원인**: `createTextSprite(displayName, labelColor, 14)` 고정값 사용

**해결책**:
```typescript
// frontend/components/graph/Graph3D.tsx

// UI-006 FIX: 중심성 기반 폰트 스케일링
const nodeCentrality = node.centrality ?? 0;
const centralityNormalized = Math.min(1, nodeCentrality / 0.5);
const fontSize = Math.round(10 + (centralityNormalized * 12)); // 10px ~ 22px

const textSprite = createTextSprite(displayName, labelColor, fontSize);
textSprite.position.y = size + 1 + (fontSize / 14);  // 폰트 크기에 따른 위치 조정
```

**결과**: 중심성 높은 노드 = 큰 폰트, 시각적 계층 구조 제공 (10px ~ 22px 범위)

---

## Deployment Instructions

### Frontend (Vercel)
- **상태**: 자동 배포
- 커밋 푸시 시 자동으로 배포됨

### Backend (Render)
- **상태**: 수동 배포 필요 (INFRA-006)
- **경로**: Render Dashboard → `scholarag-graph-docker` → Manual Deploy → Deploy latest commit
- **주의**: Import 실행 중이 아닌지 확인 후 배포

---

## Verification Checklist

배포 후 확인 사항:

- [ ] StatusBar에 "groq / llama-3.3-70b-versatile" 표시 (UI-004)
- [ ] Node Type 토글로 노드 숨기기/표시 작동 (UI-003)
- [ ] 노드 드래그 시 jitter/oscillation 없음 (UI-005)
- [ ] 중심성 높은 노드의 라벨이 더 크게 표시 (UI-006)

---

## Lessons Learned

### 1. d3-force 파라미터 방향 혼동
- `Decay` 파라미터는 **높은 값 = 빠른 감쇠**
- 직관과 반대로 느껴질 수 있으므로 공식 문서 확인 필수

### 2. 환경변수 vs Settings 객체
- Production에서 환경변수가 설정되어도 settings 객체가 기본값 사용할 수 있음
- `os.getenv()` 직접 사용으로 신뢰성 확보

### 3. useEffect 자동 동기화 문제
- `useEffect`가 상태 변경을 트리거하면 사용자 입력을 덮어쓸 수 있음
- `hasInitialized` 플래그로 초기화 후 사용자 자유도 보장

---

## Session Statistics

| Metric | Value |
|--------|-------|
| Files Modified | 4 |
| Lines Changed | ~80 |
| Commits | 2 |
| Issues Fixed | 4 |
| Deployment Required | Frontend: Auto, Backend: Manual |

---

## Related Documents

- [Action Items](../project-management/action-items.md)
- [Graph Visualization Architecture](../architecture/graph-visualization.md)
- [Frontend CORS Error Handling](../development/frontend-cors-error-handling.md)

---

*Generated by Claude Code on 2026-01-21*
